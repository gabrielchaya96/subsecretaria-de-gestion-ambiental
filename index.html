
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión Ambiental - Municipalidad de Salta</title>

    <!-- 1. Bootstrap 5 (CSS) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

    <!-- 2. Leaflet (Mapas) CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <!-- 3. FontAwesome (Iconos) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Estilos personalizados -->
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f8f9fa;
        }

        :root {
            --color-primario: #004a99;
            --color-secundario: #02b3e4;
            --color-gestion: #009a44;
            --color-texto: #333;
        }

        .header-navbar {
            background-color: #ffffff;
            border-bottom: 4px solid var(--color-gestion);
            padding: 1rem 2rem;
        }
        .header-navbar .navbar-brand {
            display: flex;
            align-items: center;
            color: var(--color-texto);
            font-weight: 700;
        }
        .header-navbar .navbar-brand i {
            font-size: 2.5rem;
            color: var(--color-gestion);
            margin-right: 15px;
        }
        .header-navbar .navbar-brand .header-title-span {
            font-size: 1.35rem;
            line-height: 1.2;
        }
        .header-navbar .navbar-brand span small {
            font-size: 1rem;
            color: #6c757d;
            display: block;
        }

        .sidebar {
            background-color: #ffffff;
            border-right: 1px solid #dee2e6;
            height: calc(100vh - 90px);
            position: sticky;
            top: 90px;
            padding-top: 1.5rem;
            overflow-y: auto;
        }
        .nav-pills .nav-link {
            display: flex;
            align-items: center;
            color: #495057;
            padding: 0.75rem 1.25rem;
            margin-bottom: 0.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
        }
        .nav-pills .nav-link i {
            margin-right: 12px;
            font-size: 1.1rem;
            width: 20px;
            text-align: center;
            color: #adb5bd;
        }
        .nav-pills .nav-link:hover {
            background-color: #f1f3f5;
            color: var(--color-primario);
        }
        .nav-pills .nav-link.active {
            background-color: var(--color-gestion);
            color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 154, 68, 0.2);
        }
        .nav-pills .nav-link.active i {
            color: #ffffff;
        }
        
        .main-content {
            padding: 2rem;
            height: calc(100vh - 90px);
            overflow-y: auto;
        }
        
        .section-title {
            color: var(--color-primario);
            font-weight: 700;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 0.5rem;
        }

        .kpi-card {
            border: none;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            background-color: #ffffff;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .kpi-card .card-body {
            display: flex;
            align-items: center;
            padding: 1.5rem;
        }
        .kpi-card-icon {
            font-size: 2.5rem;
            padding: 1.25rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1.25rem;
        }
        .kpi-icon-green { background-color: #e6f6e6; color: #009a44; }
        .kpi-icon-blue { background-color: #e0f3ff; color: #02b3e4; }
        .kpi-icon-orange { background-color: #fff4e6; color: #ff8c00; }
        .kpi-icon-purple { background-color: #f3e8ff; color: #7b2cbf; }
        .kpi-icon-red { background-color: #ffeeee; color: #d90429; }
        
        .kpi-card-content .kpi-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--color-texto);
            line-height: 1;
            margin-bottom: 0.25rem;
        }
        .kpi-card-content .kpi-label {
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 0;
            white-space: normal;
        }

        .chart-container {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
        }
        .chart-container h5 {
            font-weight: 600;
            color: #495057;
            margin-bottom: 1rem;
        }

        #map {
            height: 450px;
            width: 100%;
            border-radius: 0.5rem;
            z-index: 1;
        }

        .section-description {
            background-color: #eef7ff;
            border-left: 5px solid var(--color-secundario);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 2rem;
            font-size: 0.95rem;
            color: #333;
        }
        .section-description p {
            margin-bottom: 0.5rem;
        }
        .section-description p:last-child {
            margin-bottom: 0;
        }

        .download-section {
            background-color: #e9ecef;
            padding: 1.5rem;
            border-radius: 0.75rem;
        }

        .footer {
            text-align: center;
            padding: 1.5rem;
            background-color: #343a40;
            color: #f8f9fa;
            font-size: 0.9rem;
        }
        .footer p {
            margin-bottom: 0;
        }

        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
        }
        #loader p {
            margin-top: 1rem;
            font-weight: 500;
            color: var(--color-primario);
        }

        .alert-warning {
            background-color: #fff3cd;
            border-left: 5px solid #ffc107;
        }

        @media print {
            body {
                background-color: #ffffff;
            }
            .sidebar, .header-navbar, .download-section, .footer {
                display: none;
            }
            .main-content {
                width: 100%;
                height: auto;
                overflow-y: visible;
                padding: 0;
            }
            .col-lg-9 {
                width: 100% !important;
                flex: 0 0 100%;
                max-width: 100%;
            }
            .kpi-card, .chart-container {
                box-shadow: none;
                border: 1px solid #dee2e6;
                page-break-inside: avoid;
            }
            #map {
                display: none;
            }
            .chart-container canvas {
                max-width: 100% !important;
            }
        }
    </style>
</head>
<body>

    <div id="loader">
        <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Cargando...</span>
        </div>
        <p>Cargando datos de gestión...</p>
    </div>

    <nav class="navbar header-navbar">
        <a class="navbar-brand" href="#">
            <i class="fa-solid fa-seedling"></i>
            <span class="header-title-span">
                Subsecretaría de Gestión Ambiental
                <small>Ing. Maria Emilse Arias</small>
            </span>
        </a>
    </nav>

    <div class="container-fluid">
        <div class="row">

            <nav id="sidebarMenu" class="col-lg-3 d-none d-lg-block sidebar">
                <div class="position-sticky">
                    <ul class="nav nav-pills flex-column" id="main-nav">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-section="Dir. Gral. de Educación Ambiental">
                                <i class="fa-solid fa-graduation-cap"></i>
                                Dir. Gral. Educación Ambiental
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="Dir. Gral. de Desarrollo Sostenible">
                                <i class="fa-solid fa-recycle"></i>
                                Dir. Gral. Desarrollo Sostenible
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="Dir. Gral. de Cambio Climático">
                                <i class="fa-solid fa-cloud-sun-rain"></i>
                                Dir. Gral. Cambio Climático
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="Dirección de Desarrollo Sostenible">
                                <i class="fa-solid fa-leaf"></i>
                                Dir. Desarrollo Sostenible
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="Dirección de Inspecciones">
                                <i class="fa-solid fa-clipboard-check"></i>
                                Dir. Inspecciones
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="Dirección de Impacto Ambiental">
                                <i class="fa-solid fa-mountain-sun"></i>
                                Dir. Impacto Ambiental
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="Direccion de Patrulla Ambiental">
                                <i class="fa-solid fa-shield-halved"></i>
                                Dir. Patrulla Ambiental
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-section="Coordinación de Proyectos Ambientales">
                                <i class="fa-solid fa-tree-city"></i>
                                Coord. Proyectos Ambientales
                            </a>
                        </li>
                         <li class="nav-item">
                            <a class="nav-link" href="#" data-section="Subsecretaría (Articulación)">
                                <i class="fa-solid fa-bullhorn"></i>
                                Subsecretaría (Articulación)
                            </a>
                        </li>
                    </ul>

                    <div class="download-section mt-4 mx-3">
                        <h6 class="fw-bold">Reportes</h6>
                        <p class="small text-muted">Descargue los datos completos o genere un PDF.</p>
                        <button class="btn btn-sm btn-success w-100 mb-2" id="download-csv">
                            <i class="fa-solid fa-file-csv me-1"></i> Descargar .CSV
                        </button>
                        <button class="btn btn-sm btn-danger w-100" id="download-pdf">
                            <i class="fa-solid fa-file-pdf me-1"></i> Generar .PDF
                        </button>
                    </div>

                </div>
            </nav>

            <main class="col-lg-9 ms-sm-auto main-content">
                <div id="main-content-area">
                </div>

                <footer class="footer mt-5">
                    <p>&copy; 2025 Municipalidad de Salta - Subsecretaría de Gestión Ambiental. Todos los derechos reservados.</p>
                </footer>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script type="module">
        const CONFIG = {
            GOOGLE_SHEET_ID: '1pV10qTgEWIRtmpVpZEJMFa_G9dluMACSoKFw6JNvFQ4',
            SHEET_INDICADORES: 'INDICADORES',
            SHEET_BARRIOS: 'BARRIOS INTERVENIDOS',
        };

        const mockIndicadores = [
            {"INDICADOR": "TALLERES DE EDUCACIÓN AMBIENTAL", "AREA/DEPENDENCIA": "Dir. Gral. de Educación Ambiental", "ACUMULADO TOTAL": 3600, "ACUMULADO 2024": 3600, "ACUMULADO 2025": 2500, "ACUMULADO 2026": 0},
            {"INDICADOR": "PROMESA DE LEALTAD AL AMBIENTE", "AREA/DEPENDENCIA": "Dir. Gral. de Educación Ambiental", "ACUMULADO TOTAL": 5800, "ACUMULADO 2024": 5800, "ACUMULADO 2025": 0, "ACUMULADO 2026": 0},
            {"INDICADOR": "NEUMATÓN", "AREA/DEPENDENCIA": "Dir. Gral. de Economía Circular", "ACUMULADO TOTAL": 2072, "ACUMULADO 2024": 2072, "ACUMULADO 2025": 0, "ACUMULADO 2026": 0},
            {"INDICADOR": "RAEETÓN", "AREA/DEPENDENCIA": "Dir. Gral. de Economía Circular", "ACUMULADO TOTAL": 95.98, "ACUMULADO 2024": 95.98, "ACUMULADO 2025": 0, "ACUMULADO 2026": 0},
            {"INDICADOR": "PUNTOS LIMPIOS INSTALADOS", "AREA/DEPENDENCIA": "Dir. Gral. de Economía Circular", "ACUMULADO TOTAL": 2, "ACUMULADO 2024": 2, "ACUMULADO 2025": 0, "ACUMULADO 2026": 0},
            {"INDICADOR": "MEDICIONES DE CALIDAD DEL AIRE", "AREA/DEPENDENCIA": "Dir. Gral. de Cambio Climático", "ACUMULADO TOTAL": 54, "ACUMULADO 2024": 54, "ACUMULADO 2025": 0, "ACUMULADO 2026": 0},
            {"INDICADOR": "ACCIONES DE DESCACHARRADO", "AREA/DEPENDENCIA": "Dir. Gral. de Cambio Climático", "ACUMULADO TOTAL": 45, "ACUMULADO 2024": 45, "ACUMULADO 2025": 0, "ACUMULADO 2026": 0},
            {"INDICADOR": "CONVENIOS FIRMADOS", "AREA/DEPENDENCIA": "Subsecretaría de Gestión Ambiental", "ACUMULADO TOTAL": 18, "ACUMULADO 2024": 13, "ACUMULADO 2025": 5, "ACUMULADO 2026": 0},
            {"INDICADOR": "CAMPAÑAS DE COMUNICACIÓN", "AREA/DEPENDENCIA": "Subsecretaría de Gestión Ambiental", "ACUMULADO TOTAL": 12, "ACUMULADO 2024": 12, "ACUMULADO 2025": 0, "ACUMULADO 2026": 0},
            {"INDICADOR": "HUERTAS COMUNITARIAS", "AREA/DEPENDENCIA": "Dir. Gral. de Desarrollo Sostenible", "ACUMULADO TOTAL": 5, "ACUMULADO 2024": 5, "ACUMULADO 2025": 0, "ACUMULADO 2026": 0},
        ];

        const mockBarrios = [
            {"NOMBRE DEL BARRIO": "Norte Grande", "TAREAS DESARROLLADAS": "Descacharrado/Educacion Sanitaria Dengue", "lat": -24.819, "lng": -65.422},
            {"NOMBRE DEL BARRIO": "Villa Floresta Alta", "TAREAS DESARROLLADAS": "Descacharrado/Educacion Sanitaria Dengue", "lat": -24.786, "lng": -65.389},
            {"NOMBRE DEL BARRIO": "Bº San Calixto", "TAREAS DESARROLLADAS": "Descacharrado/Educacion Sanitaria Dengue", "lat": -24.825, "lng": -65.435},
            {"NOMBRE DEL BARRIO": "Bº VILLA ESMERALDA", "TAREAS DESARROLLADAS": "OPERATIVO MILAGRO", "lat": -24.820, "lng": -65.441},
            {"NOMBRE DEL BARRIO": "Bº LIMACHE", "TAREAS DESARROLLADAS": "OPERATIVO MILAGRO", "lat": -24.836, "lng": -65.451},
        ];

        const mockPuntosLimpios = [
            {"NOMBRE": "Punto Limpio Norte", "DIRECCION": "Av. Bolivia 2550", "lat": -24.746, "lng": -65.412},
            {"NOMBRE": "Punto Limpio Sur", "DIRECCION": "Av. Paraguay 1240", "lat": -24.809, "lng": -65.418},
        ];

        let indicatorsData = [];
        let barriosData = [];
        let chartInstances = {};
        let mapInstance = null;
        let dataLoaded = false;

        const SALTA_CENTER = [-24.7859, -65.4117];

        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
            setupNavigation();
            setupDownloadButtons();
        });

        async function initializeApp() {
            const loader = document.getElementById('loader');
            try {
                const [indicators, barrios] = await Promise.all([
                    fetchGoogleSheetData(CONFIG.GOOGLE_SHEET_ID, CONFIG.SHEET_INDICADORES),
                    fetchGoogleSheetData(CONFIG.GOOGLE_SHEET_ID, CONFIG.SHEET_BARRIOS)
                ]);
                
                if (indicators && indicators.length > 0) {
                    indicatorsData = indicators;
                    dataLoaded = true;
                    console.log("✅ Datos cargados desde Google Sheets");
                } else {
                    throw new Error("No se encontraron datos");
                }
                
                if (barrios && barrios.length > 0 && barrios[0].lat) {
                    barriosData = barrios;
                } else {
                    console.warn("⚠️ Usando datos mock para barrios");
                    barriosData = mockBarrios;
                }

            } catch (error) {
                console.error("❌ Error al cargar datos. Usando mock data:", error);
                indicatorsData = mockIndicadores;
                barriosData = mockBarrios;
                dataLoaded = false;
                
                showWarningBanner();
            } finally {
                renderSection('Dir. Gral. de Educación Ambiental');
                loader.style.display = 'none';
            }
        }

        function showWarningBanner() {
            const container = document.getElementById('main-content-area');
            const banner = `
                <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    <i class="fa-solid fa-triangle-exclamation me-2"></i>
                    <strong>¡Atención!</strong> No se pudieron cargar los datos desde Google Sheets. 
                    Asegúrate de que la hoja esté compartida públicamente. Mostrando datos de ejemplo.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            container.insertAdjacentHTML('afterbegin', banner);
        }

        function setupNavigation() {
            const navLinks = document.querySelectorAll('#main-nav .nav-link');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navLinks.forEach(l => l.classList.remove('active'));
                    e.currentTarget.classList.add('active');
                    const sectionName = e.currentTarget.getAttribute('data-section');
                    renderSection(sectionName);
                });
            });
        }

        function setupDownloadButtons() {
            document.getElementById('download-csv').addEventListener('click', exportToCSV);
            document.getElementById('download-pdf').addEventListener('click', () => {
                window.print();
            });
        }

        function renderSection(sectionName) {
            const container = document.getElementById('main-content-area');
            container.innerHTML = '';
            destroyCharts();
            destroyMap();

            const title = document.createElement('h2');
            title.className = 'section-title';
            title.textContent = sectionName;
            container.appendChild(title);

            switch (sectionName) {
                case 'Dir. Gral. de Educación Ambiental':
                    renderEducacion(container);
                    break;
                case 'Dir. Gral. de Desarrollo Sostenible':
                    renderEconomia(container);
                    break;
                case 'Dir. Gral. de Cambio Climático':
                    renderCambioClimatico(container);
                    break;
                case 'Dirección de Desarrollo Sostenible':
                    renderDesarrollo(container);
                    break;
                case 'Dirección de Inspecciones':
                    renderInspecciones(container);
                    break;
                case 'Dirección de Impacto Ambiental':
                    renderImpacto(container);
                    break;
                case 'Direccion de Patrulla Ambiental':
                    renderPatrulla(container);
                    break;
                case 'Coordinación de Proyectos Ambientales':
                    renderProyectos(container);
                    break;
                case 'Subsecretaría (Articulación)':
                    renderComunicacion(container);
                    break;
                default:
                    container.innerHTML = '<p>Sección en construcción.</p>';
            }
        }

        function renderEducacion(container) {
            container.innerHTML += `
                <div class="section-description">
                    <p>Esta área se encarga de actividades como talleres de educación ambiental, operativos puerta a puerta, la conformación de la mesa intersectorial de Educación Ambiental, eventos de siembra de árboles, capacitación de docentes, y la difusión de contenido ambiental en redes y medios.</p>
                </div>
            `;

            const data = indicatorsData.filter(d => d['AREA/DEPENDENCIA'] === 'Dir. Gral. de Educación Ambiental');
            const talleres = findIndicator(data, 'TALLERES');
            const promesa = findIndicator(data, 'PROMESA');

            const hasTalleres = talleres['ACUMULADO TOTAL'] > 0;
            const hasPromesa = promesa['ACUMULADO TOTAL'] > 0;

            if (!hasTalleres && !hasPromesa) {
                container.innerHTML += `
                    <div class="alert alert-info" role="alert">
                        <i class="fa-solid fa-info-circle me-2"></i>
                        No hay datos disponibles para esta dirección. Verifica que la hoja de Google Sheets contenga datos para "Dir. Gral. de Educación Ambiental".
                    </div>
                `;
                return;
            }

            container.innerHTML += `
                <div class="row g-4 mb-4">
                    <div class="col-md-6 col-lg-4">
                        ${createKpiCard('Neumáticos (Tn)', neumaticos['ACUMULADO TOTAL'], 'fa-solid fa-truck-monster', 'kpi-icon-orange')}
                    </div>
                    <div class="col-md-6 col-lg-4">
                        ${createKpiCard('RAEE (Tn)', raee['ACUMULADO TOTAL'], 'fa-solid fa-laptop-medical', 'kpi-icon-purple')}
                    </div>
                    <div class="col-md-6 col-lg-4">
                        ${createKpiCard('Puntos Limpios Instalados', puntosLimpios['ACUMULADO TOTAL'], 'fa-solid fa-map-pin', 'kpi-icon-green')}
                    </div>
                </div>
                
                <div class="row g-4">
                    <div class="col-lg-12">
                        <div class="chart-container">
                            <h5>Mapa de Puntos Limpios</h5>
                            <div id="map"></div>
                        </div>
                    </div>
                </div>
            `;
            
            animateCounter('kpi-neumaticos-tn', neumaticos['ACUMULADO TOTAL']);
            animateCounter('kpi-raee-tn', raee['ACUMULADO TOTAL']);
            animateCounter('kpi-puntos-limpios-instalados', puntosLimpios['ACUMULADO TOTAL']);

            initializeMap(mockPuntosLimpios, 'punto-limpio');
        }

        function renderCambioClimatico(container) {
            container.innerHTML += `
                <div class="section-description">
                    <p>Colabora en la RAEETÓN, el Neumatón (a través de la certificación de disposición final), y se enfoca en el mapeo de calidad de aire y ruido ambiental, el relevamiento y toma de muestras de agua en los ríos Arias-Arenales, la implementación de Biobardas, y las actividades de descacharrado y retiro de chatarra.</p>
                </div>
            `;

            const data = indicatorsData.filter(d => d['AREA/DEPENDENCIA'] === 'Dir. Gral. de Cambio Climático');
            const medicionesAire = findIndicator(data, 'CALIDAD DEL AIRE');
            const descacharrado = findIndicator(data, 'DESCACHARRADO');
            
            const barriosIntervenidos = barriosData.filter(b => 
                b['TAREAS DESARROLLADAS'] && b['TAREAS DESARROLLADAS'].toLowerCase().includes('descacharrado')
            );

            container.innerHTML += `
                <div class="row g-4 mb-4">
                    <div class="col-md-6 col-lg-4">
                        ${createKpiCard('Mediciones Calidad de Aire', medicionesAire['ACUMULADO TOTAL'], 'fa-solid fa-wind', 'kpi-icon-blue')}
                    </div>
                    <div class="col-md-6 col-lg-4">
                        ${createKpiCard('Barrios con Descacharrado', barriosIntervenidos.length, 'fa-solid fa-house-chimney-medical', 'kpi-icon-red')}
                    </div>
                </div>
                
                <div class="row g-4">
                    <div class="col-lg-12">
                        <div class="chart-container">
                            <h5>Mapa de Barrios Intervenidos (Descacharrado)</h5>
                            <div id="map"></div>
                        </div>
                    </div>
                </div>
            `;
            
            animateCounter('kpi-mediciones-calidad-de-aire', medicionesAire['ACUMULADO TOTAL']);
            animateCounter('kpi-barrios-con-descacharrado', barriosIntervenidos.length);

            initializeMap(barriosIntervenidos, 'barrio');
        }

        function renderDesarrollo(container) {
            container.innerHTML += `
                <div class="section-description">
                    <p>Se menciona en tareas de formulación de proyectos y relevamiento a plantas de tratamiento. El indicador de "Huertas" proviene de los datos de "Dir. Gral. de Desarrollo Sostenible".</p>
                </div>
            `;

            const data = indicatorsData.filter(d => d['AREA/DEPENDENCIA'] === 'Dir. Gral. de Desarrollo Sostenible');
            const huertas = findIndicator(data, 'HUERTAS');

            container.innerHTML += `
                <div class="row g-4 mb-4">
                    <div class="col-md-6 col-lg-4">
                        ${createKpiCard('Huertas Comunitarias', huertas['ACUMULADO TOTAL'], 'fa-solid fa-carrot', 'kpi-icon-orange')}
                    </div>
                </div>
                <div class="row g-4">
                    <div class="col-lg-12">
                        <div class="chart-container">
                            <h5>Comparativa Huertas Creadas</h5>
                            <div class="chart-wrapper" style="position: relative; height: 350px;">
                                <canvas id="chart-huertas"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            animateCounter('kpi-huertas-comunitarias', huertas['ACUMULADO TOTAL']);
            
            createBarChart(
                'chart-huertas',
                ['2024', '2025', '2026 (Meta)'],
                'Huertas',
                [huertas['ACUMULADO 2024'], huertas['ACUMULADO 2025'], huertas['ACUMULADO 2026']],
                '#ff8c00'
            );
        }

        function renderComunicacion(container) {
            container.innerHTML += `
                <div class="section-description">
                    <p>Indicadores de alto nivel gestionados directamente por la Subsecretaría, incluyendo convenios interinstitucionales y campañas de comunicación masiva.</p>
                </div>
            `;

            const data = indicatorsData.filter(d => d['AREA/DEPENDENCIA'] === 'Subsecretaría de Gestión Ambiental');
            const convenios = findIndicator(data, 'CONVENIOS');
            const campanas = findIndicator(data, 'CAMPAÑAS');

            container.innerHTML += `
                <div class="row g-4 mb-4">
                    <div class="col-md-6 col-lg-4">
                        ${createKpiCard('Convenios Firmados', convenios['ACUMULADO TOTAL'], 'fa-solid fa-handshake', 'kpi-icon-purple')}
                    </div>
                    <div class="col-md-6 col-lg-4">
                        ${createKpiCard('Campañas de Comunicación', campanas['ACUMULADO TOTAL'], 'fa-solid fa-microphone-lines', 'kpi-icon-blue')}
                    </div>
                </div>
            `;
            
            animateCounter('kpi-convenios-firmados', convenios['ACUMULADO TOTAL']);
            animateCounter('kpi-campanas-de-comunicacion', campanas['ACUMULADO TOTAL']);
        }

        function renderInspecciones(container) {
            container.innerHTML += `
                <div class="section-description">
                    <p>Realiza inspecciones, inspecciones conjuntas (con la Dirección de Inspecciones Comerciales), labra actas de comprobación y actas de clausura, y ejecuta operativos de fiscalización.</p>
                </div>
                <div class="alert alert-info" role="alert">
                    <i class="fa-solid fa-info-circle me-2"></i>
                    No hay indicadores numéricos (KPIs) disponibles en la hoja de datos para esta Dirección.
                </div>
            `;
        }

        function renderImpacto(container) {
            container.innerHTML += `
                <div class="section-description">
                    <p>Es responsable de la emisión de las Resoluciones de CAAM (Certificado de Aptitud Ambiental) y de la capacitación o asesoramiento para la obtención del mismo.</p>
                </div>
                <div class="alert alert-info" role="alert">
                    <i class="fa-solid fa-info-circle me-2"></i>
                    No hay indicadores numéricos (KPIs) disponibles en la hoja de datos para esta Dirección.
                </div>
            `;
        }

        function renderPatrulla(container) {
            container.innerHTML += `
                <div class="section-description">
                    <p>Sus funciones incluyen operativos de fiscalización y control de microbasurales, colaboraciones especiales con otras áreas municipales, la generación de reportes diarios/denuncias, y la emisión de actas de infracción y cédulas de notificación.</p>
                </div>
                <div class="alert alert-info" role="alert">
                    <i class="fa-solid fa-info-circle me-2"></i>
                    No hay indicadores numéricos (KPIs) disponibles en la hoja de datos para esta Dirección.
                </div>
            `;
        }

        function renderProyectos(container) {
            container.innerHTML += `
                <div class="section-description">
                    <p>Se encarga de la puesta a punto, el enriquecimiento y el mantenimiento de espacios verdes (plazas, platabandas, rotondas, etc.).</p>
                </div>
                <div class="alert alert-info" role="alert">
                    <i class="fa-solid fa-info-circle me-2"></i>
                    No hay indicadores numéricos (KPIs) disponibles en la hoja de datos para esta Dirección.
                </div>
            `;
        }

        function createKpiCard(label, value, iconClass, colorClass) {
            const safeValue = value || 0;
            const kpiId = `kpi-${label.toLowerCase().replace(/[^a-z0-9]/g, '-')}`;
            
            return `
                <div class="kpi-card">
                    <div class="card-body">
                        <div class="kpi-card-icon ${colorClass}">
                            <i class="${iconClass}"></i>
                        </div>
                        <div class="kpi-card-content">
                            <div class="kpi-value" id="${kpiId}">0</div>
                            <p class="kpi-label">${label}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function createBarChart(canvasId, labels, dataLabel, data, color = '#02b3e4') {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            const chart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: dataLabel,
                        data: data,
                        backgroundColor: color,
                        borderRadius: 5,
                        barPercentage: 0.6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                display: true,
                                color: '#e9ecef'
                            },
                            ticks: {
                                color: '#6c757d'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                color: '#6c757d'
                            }
                        }
                    }
                }
            });
            chartInstances[canvasId] = chart;
        }

        function destroyCharts() {
            Object.values(chartInstances).forEach(chart => chart.destroy());
            chartInstances = {};
        }

        function initializeMap(markersData, type) {
            if (mapInstance) {
                mapInstance.remove();
                mapInstance = null;
            }

            const mapEl = document.getElementById('map');
            if (!mapEl) return;

            mapInstance = L.map('map').setView(SALTA_CENTER, 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapInstance);

            const barrioIcon = L.icon({
                iconUrl: 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#D90429" width="32px" height="32px"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>'),
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });
            
            const puntoLimpioIcon = L.icon({
                iconUrl: 'data:image/svg+xml;base64,' + btoa('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#009A44" width="32px" height="32px"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>'),
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });

            markersData.forEach(d => {
                if (d.lat && d.lng) {
                    let popupContent = '';
                    let icon = barrioIcon;

                    if (type === 'barrio') {
                        popupContent = `<strong>${d['NOMBRE DEL BARRIO']}</strong><br>${d['TAREAS DESARROLLADAS']}`;
                        icon = barrioIcon;
                    } else if (type === 'punto-limpio') {
                        popupContent = `<strong>${d['NOMBRE']}</strong><br>${d['DIRECCION']}`;
                        icon = puntoLimpioIcon;
                    }
                    
                    L.marker([d.lat, d.lng], { icon: icon })
                        .addTo(mapInstance)
                        .bindPopup(popupContent);
                }
            });
            
            if (markersData.length > 0) {
                const group = new L.featureGroup(markersData.map(d => L.marker([d.lat, d.lng])));
                mapInstance.fitBounds(group.getBounds().pad(0.1));
            }
        }
        
        function destroyMap() {
            if (mapInstance) {
                mapInstance.remove();
                mapInstance = null;
            }
        }

        function animateCounter(id, endValue) {
            const el = document.getElementById(id);
            if (!el) return;

            let startValue = 0;
            const duration = 1500;
            const stepTime = 20;
            const steps = duration / stepTime;
            const increment = endValue / steps;
            
            const isFloat = endValue % 1 !== 0;

            const timer = setInterval(() => {
                startValue += increment;
                if (startValue >= endValue) {
                    clearInterval(timer);
                    el.textContent = isFloat ? endValue.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : endValue.toLocaleString('es-AR');
                } else {
                    el.textContent = isFloat ? startValue.toLocaleString('es-AR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) : Math.ceil(startValue).toLocaleString('es-AR');
                }
            }, stepTime);
        }

        function findIndicator(data, nameSubstring) {
            const lowerCaseName = nameSubstring.toLowerCase();
            return data.find(d => d.INDICADOR && d.INDICADOR.toLowerCase().includes(lowerCaseName)) || 
                   { "ACUMULADO TOTAL": 0, "ACUMULADO 2024": 0, "ACUMULADO 2025": 0, "ACUMULADO 2026": 0 };
        }
        
        function exportToCSV() {
            if (!indicatorsData.length) {
                alert("No hay datos disponibles para exportar.");
                return;
            }

            const headers = Object.keys(indicatorsData[0]);
            let csvContent = "data:text/csv;charset=utf-8,";
            
            csvContent += headers.join(";") + "\r\n";

            indicatorsData.forEach(row => {
                const values = headers.map(header => {
                    let cell = row[header] === null || row[header] === undefined ? '' : row[header];
                    cell = String(cell).replace(/"/g, '""');
                    if (cell.includes(';') || cell.includes(',')) {
                        cell = `"${cell}"`;
                    }
                    return cell;
                });
                csvContent += values.join(";") + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "reporte_gestion_ambiental.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        async function fetchGoogleSheetData(sheetId, sheetName) {
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
            
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Error HTTP: ${response.statusText}`);
            }

            let text = await response.text();
            
            const startIndex = text.indexOf('(') + 1;
            const endIndex = text.lastIndexOf(')');
            
            if (startIndex === 0 || endIndex === -1) {
                throw new Error("Respuesta inválida de Google Sheets");
            }

            const jsonText = text.substring(startIndex, endIndex);
            const data = JSON.parse(jsonText);
            
            if (data.status === 'error') {
                throw new Error(`Error en Google Sheets: ${data.errors.map(e => e.detailed_message).join(', ')}`);
            }

            return parseGoogleSheetResponse(data.table);
        }
        
        function parseGoogleSheetResponse(table) {
            const headers = table.cols.map(col => col.label || col.id);
            const rows = table.rows.map(row => {
                const obj = {};
                row.c.forEach((cell, i) => {
                    const header = headers[i];
                    let value = null;
                    if (cell) {
                        value = cell.f || cell.v;
                    }
                    if (typeof value === 'string' && !isNaN(parseFloat(value.replace(',', '.')))) {
                        obj[header] = parseFloat(value.replace(',', '.'));
                    } else {
                        obj[header] = value;
                    }
                });
                return obj;
            });
            return rows;
        }

    </script>
</body>
</html>col-lg-4">
                        ${createKpiCard('Niños en Talleres', talleres['ACUMULADO TOTAL'], 'fa-solid fa-school', 'kpi-icon-green')}
                    </div>
                    <div class="col-md-6 col-lg-4">
                        ${createKpiCard('Alumnos en "Promesa al Ambiente"', promesa['ACUMULADO TOTAL'], 'fa-solid fa-children', 'kpi-icon-blue')}
                    </div>
                </div>
                
                <div class="row g-4">
                    <div class="col-lg-12">
                        <div class="chart-container">
                            <h5>Comparativa Anual de Talleres</h5>
                            <div class="chart-wrapper" style="position: relative; height: 350px;">
                                <canvas id="chart-talleres"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            if (hasTalleres) animateCounter('kpi-ninos-en-talleres', talleres['ACUMULADO TOTAL']);
            if (hasPromesa) animateCounter('kpi-alumnos-en-promesa-al-ambiente', promesa['ACUMULADO TOTAL']);

            if (hasTalleres) {
                createBarChart(
                    'chart-talleres',
                    ['2024', '2025', '2026 (Meta)'],
                    'Niños capacitados',
                    [talleres['ACUMULADO 2024'], talleres['ACUMULADO 2025'], talleres['ACUMULADO 2026']],
                    '#009a44'
                );
            }
        }

        function renderEconomia(container) {
            container.innerHTML += `
                <div class="section-description">
                    <p>Participa en actividades como el Neumatón (recolección de Neumáticos Fuera de Uso), la RAEETÓN (recolección de Residuos Electrónicos y Eléctricos en Desuso), la formulación de proyectos, la instalación de Ecopuntos y Puntos Limpios, y la coordinación de retiros masivos de NFU.</p>
                    <p class="fw-bold small text-muted mb-0">Nota: Los indicadores (Neumatón, RAEETÓN, Puntos Limpios) provienen de los datos de "Dir. Gral. de Economía Circular" y se muestran aquí según la nueva estructura de áreas.</p>
                </div>
            `;

            const data = indicatorsData.filter(d => d['AREA/DEPENDENCIA'] === 'Dir. Gral. de Economía Circular');
            const neumaticos = findIndicator(data, 'NEUMATÓN');
            const raee = findIndicator(data, 'RAEETÓN');
            const puntosLimpios = findIndicator(data, 'PUNTOS LIMPIOS');

            container.innerHTML += `
                <div class="row g-4 mb-4">
                    <div class="col-md-6
