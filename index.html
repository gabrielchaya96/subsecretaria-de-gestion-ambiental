<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subsecretaría de Gestión Ambiental - Salta</title>

    <!-- 1. Bootstrap 5 (CSS) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

    <!-- 2. Leaflet (Mapas) CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>

    <!-- 3. FontAwesome (Iconos) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Estilos personalizados -->
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f8f9fa;
        }

        :root {
            --color-primario: #004d40; /* Verde oscuro (Base) */
            --color-secundario: #4caf50; /* Verde claro (Acento) */
            --color-info: #17a2b8; /* Turquesa/Celeste */
            --color-advertencia: #ffc107; /* Amarillo */
        }

        .header {
            background-color: var(--color-primario);
            color: white;
            padding: 20px 0;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        .header .lead {
            font-size: 1rem;
            opacity: 0.9;
        }

        .sidebar {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
            padding: 0;
        }
        .nav-link {
            padding: 1rem 1.5rem;
            color: var(--color-primario);
            font-weight: 600;
            transition: all 0.2s;
        }
        .nav-link.active {
            background-color: var(--color-secundario);
            color: white;
            border-radius: 8px 8px 0 0;
        }
        .nav-link:hover:not(.active) {
            background-color: #e9ecef;
            color: var(--color-primario);
        }
        .content {
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
            padding: 30px;
        }
        .indicator-card {
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
            border: 1px solid #e9ecef;
        }
        .indicator-card:hover {
            transform: translateY(-2px);
        }
        .card-title {
            font-size: 0.9rem;
            color: #6c757d;
        }
        .card-number {
            font-size: 2.0rem;
            font-weight: 700;
            color: var(--color-primario);
        }
        .chart-container, .map-container-wrapper {
            margin-top: 30px;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background-color: #fff;
        }
        .map-container {
            height: 400px;
            border-radius: 8px;
        }
        .chart-wrapper {
            position: relative;
            height: 350px; /* Tamaño fijo para gráficos */
        }
        .no-data-message {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100%;
            color: #6c757d;
            font-style: italic;
            border: 1px dashed #ced4da;
            border-radius: 8px;
        }
        .loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .section-description {
            margin-bottom: 25px;
            padding: 15px;
            background-color: #f1f8e9; /* Verde muy claro */
            border-left: 5px solid var(--color-secundario);
            border-radius: 4px;
        }
    </style>
</head>
<body>

    <!-- Loader -->
    <div id="loader" class="loader-overlay">
        <div class="spinner-border text-success" role="status">
            <span class="visually-hidden">Cargando...</span>
        </div>
    </div>

    <header class="header">
        <div class="container">
            <div class="d-flex align-items-center">
                <i class="fas fa-tree me-3 fa-2x"></i>
                <div>
                    <h1>Subsecretaría de Gestión Ambiental</h1>
                    <p class="lead mb-0">Ing. Maria Emilse Arias - Seguimiento de Indicadores</p>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="row">
            <!-- Menú Lateral -->
            <div class="col-lg-3 mb-4">
                <div class="sidebar">
                    <div class="list-group list-group-flush" id="area-menu" role="tablist">
                        <!-- Las áreas deben coincidir EXCATAMENTE con el nombre en Google Sheet -->
                        <a href="#educacion" class="list-group-item list-group-item-action active" data-area="Dir. Gral. de Educación Ambiental" aria-controls="educacion" role="tab" data-bs-toggle="pill">Dir. Gral. de Educación Ambiental</a>
                        <a href="#desarrollo" class="list-group-item list-group-item-action" data-area="Dir. Gral. de Desarrollo Sostenible" aria-controls="desarrollo" role="tab" data-bs-toggle="pill">Dir. Gral. de Desarrollo Sostenible</a>
                        <a href="#cambioclimatico" class="list-group-item list-group-item-action" data-area="Dir. General de Cambio Climático" aria-controls="cambioclimatico" role="tab" data-bs-toggle="pill">Dir. General de Cambio Climático</a>
                        <a href="#desarrollo-sostenible" class="list-group-item list-group-item-action" data-area="Dir. de Desarrollo Sostenible" aria-controls="desarrollo-sostenible" role="tab" data-bs-toggle="pill">Dir. de Desarrollo Sostenible</a>
                        <a href="#inspecciones" class="list-group-item list-group-item-action" data-area="Dir. de Inspecciones" aria-controls="inspecciones" role="tab" data-bs-toggle="pill">Dir. de Inspecciones</a>
                        <a href="#impacto" class="list-group-item list-group-item-action" data-area="Dir. de Impacto Ambiental" aria-controls="impacto" role="tab" data-bs-toggle="pill">Dir. de Impacto Ambiental</a>
                        <a href="#patrulla" class="list-group-item list-group-item-action" data-area="Dir. de Patrulla Ambiental" aria-controls="patrulla" role="tab" data-bs-toggle="pill">Dir. de Patrulla Ambiental</a>
                        <a href="#proyectos" class="list-group-item list-group-item-action" data-area="Coordinación de Proyectos Ambientales" aria-controls="proyectos" role="tab" data-bs-toggle="pill">Coord. de Proyectos Ambientales</a>
                    </div>
                </div>
            </div>

            <!-- Contenido Principal -->
            <div class="col-lg-9">
                <div class="content">
                    <div class="tab-content" id="area-content-tab">
                        <div class="tab-pane fade show active" id="area-content" role="tabpanel">
                            <!-- Todo el contenido dinámico se inyecta aquí -->
                            <h2 id="area-title" class="mb-4 text-primary">Cargando...</h2>
                            
                            <div id="section-description-container">
                                <!-- Descripción inyectada aquí -->
                            </div>
                            
                            <!-- 1. INDICADORES CLAVE (Cards) -->
                            <div id="indicators-row" class="row g-4 mb-5">
                                <!-- Cards se inyectarán aquí -->
                            </div>

                            <!-- 2. Gráficos de Seguimiento -->
                            <div id="charts-container">
                                <!-- Gráfico 1: Comparativa Anual -->
                                <div class="chart-container">
                                    <h5 id="chart-talleres-title">Comparativa Anual</h5>
                                    <div class="chart-wrapper" style="position: relative; height: 350px;">
                                        <canvas id="chart-talleres"></canvas>
                                        <div id="chart-talleres-no-data" class="no-data-message d-none">No hay datos para gráfico anual.</div>
                                    </div>
                                </div>
                                
                                <!-- Gráfico 2: Mapa de Barrios (o 2do Indicador) -->
                                <div class="map-container-wrapper">
                                    <h5 id="map-huertas-title">Barrios Intervenidos</h5>
                                    <div id="map-huertas" class="map-container"></div>
                                    <div id="map-huertas-no-data" class="no-data-message d-none" style="height: 400px;">No hay datos de barrios/puntos para esta área.</div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 4. Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <!-- 5. Chart.js (Gráficos) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <!-- 6. Leaflet (Mapas) JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20n6a9K13/f5Go9+mixt5FSYf/A/tA/vD3G4/J47Q5Y=" crossorigin=""></script>

    <script type="module">
        // ---------------------------------------------------------------------
        // CONFIGURACIÓN (EL USUARIO DEBE MODIFICAR ESTO)
        // ---------------------------------------------------------------------
        const CONFIG = {
            // ID CORRECTO de la hoja de cálculo de tu URL de edición
            // Reemplaza con tu ID real para cargar datos
            GOOGLE_SHEET_ID: 'REEMPLAZA_CON_TU_GOOGLE_SHEET_ID', 
            
            // Nombres exactos de las hojas (pestañas) de tu Google Sheet
            SHEET_INDICADORES: 'INDICADORES',
            SHEET_BARRIOS: 'BARRIOS INTERVENIDOS', // Contiene barrios y puntos
            
            // COLUMNAS CRUCIALES (deben coincidir EXACTAMENTE con los encabezados de tu hoja)
            COL_AREA: 'AREA/DEPENDENCIA',
            COL_INDICADOR: 'INDICADOR',
            COL_ACUMULADO_TOTAL: 'ACUMULADO TOTAL',
            COL_TAREA: 'TAREA /ACCION',
            COL_BARRIO_TAREA: 'TAREAS DESARROLLADAS', // Columna de descripción de tarea en BARRIOS
            COL_BARRIO_NOMBRE: 'NOMBRE DEL BARRIO', // Columna de nombre de barrio
            COL_LAT: 'LATITUD', 
            COL_LON: 'LONGITUD', 
        };

        // ---------------------------------------------------------------------
        // DESCRIPCIONES DE ÁREA (Texto estático para cada sección)
        // ---------------------------------------------------------------------
        const AREA_DESCRIPTIONS = {
            'Dir. Gral. de Educación Ambiental': 'Esta área se encarga de actividades como talleres de educación ambiental, operativos puerta a puerta, la conformación de la mesa intersectorial de Educación Ambiental, eventos de siembra de árboles, capacitación de docentes, y la difusión de contenido ambiental en redes y medios.',
            'Dir. Gral. de Desarrollo Sostenible': 'Participa en actividades como el Neumatón (recolección de Neumáticos Fuera de Uso), la RAEETÓN (recolección de Residuos Electrónicos y Eléctricos en Desuso), la formulación de proyectos, la instalación de Ecopuntos y Puntos Limpios, y la coordinación de retiros masivos de NFU.',
            'Dir. General de Cambio Climático': 'Colabora en la RAEETÓN, el Neumatón (a través de la certificación de disposición final), y se enfoca en el mapeo de calidad de aire y ruido ambiental, el relevamiento y toma de muestras de agua en los ríos Arias-Arenales, la implementación de Biobardas, y las actividades de descacharrado y retiro de chatarra.',
            'Dir. de Desarrollo Sostenible': 'Se menciona en tareas de formulación de proyectos y relevamiento a plantas de tratamiento. (Nota: Esta área podría tener indicadores compartidos con Dir. Gral. de Desarrollo Sostenible).',
            'Dir. de Inspecciones': 'Realiza inspecciones, inspecciones conjuntas (con la Dirección de Inspecciones Comerciales), labra actas de comprobación y actas de clausura, y ejecuta operativos de fiscalización. (Nota: Los indicadores se basan en el conteo de actas/operativos).',
            'Dir. de Impacto Ambiental': 'Es responsable de la emisión de las Resoluciones de CAAM (Certificado de Aptitud Ambiental) y de la capacitación o asesoramiento para la obtención del mismo. (Nota: Los indicadores se basan en la cantidad de resoluciones emitidas).',
            'Dir. de Patrulla Ambiental': 'Sus funciones incluyen operativos de fiscalización y control de microbasurales, colaboraciones especiales con otras áreas municipales, la generación de reportes diarios/denuncias, y la emisión de actas de infracción y cédulas de notificación. (Nota: Los indicadores se basan en el conteo de operativos/reportes).',
            'Coordinación de Proyectos Ambientales': 'Se encarga de la puesta a punto, el enriquecimiento y el mantenimiento de espacios verdes (plazas, platabandas, rotondas, etc.). (Nota: Los indicadores se basan en el conteo de espacios verdes intervenidos).',
        };

        // ---------------------------------------------------------------------
        // VARIABLES GLOBALES Y CACHÉ DE DATOS
        // ---------------------------------------------------------------------
        let indicatorsData = []; 
        let barriosData = [];    
        let currentChart = null; 
        let currentMap = null;   

        const loader = document.getElementById('loader');
        const areaTitle = document.getElementById('area-title');
        const indicatorsRow = document.getElementById('indicators-row');
        const descriptionContainer = document.getElementById('section-description-container');
        const mapContainerId = 'map-huertas';
        
        // Nombres de columna de meses para gráficos
        const MONTH_COLUMNS = ['ENERO', 'FEBRERO', 'MARZO', 'ABRIL', 'MAYO', 'JUNIO', 'JULIO', 'AGOSTO', 'SEPTIEMBRE', 'OCTUBRE', 'NOVIEMBRE', 'DICIEMBRE'];


        // ---------------------------------------------------------------------
        // MOCK DATA (Datos de ejemplo para pruebas o fallos de conexión)
        // ---------------------------------------------------------------------
        const mockIndicadores = [
            { 'AREA/DEPENDENCIA': 'Dir. Gral. de Educación Ambiental', 'INDICADOR': 'Talleres de Educación Ambiental', 'ACUMULADO TOTAL': 150, 'TAREA /ACCION': 'Talleres realizados', 'ENERO': 10, 'FEBRERO': 20, 'MARZO': 30 },
            { 'AREA/DEPENDENCIA': 'Dir. Gral. de Educación Ambiental', 'INDICADOR': 'Eventos de Siembra de Árboles', 'ACUMULADO TOTAL': 12, 'TAREA /ACCION': 'Eventos concluidos', 'ENERO': 1, 'FEBRERO': 2, 'MARZO': 3 },
            { 'AREA/DEPENDENCIA': 'Dir. Gral. de Desarrollo Sostenible', 'INDICADOR': 'Recolección (Tn) NFU (Neumatón)', 'ACUMULADO TOTAL': 500, 'TAREA /ACCION': 'Toneladas de neumáticos', 'ENERO': 50, 'FEBRERO': 100, 'MARZO': 150 },
            { 'AREA/DEPENDENCIA': 'Dir. General de Cambio Climático', 'INDICADOR': 'Biobardas Instaladas', 'ACUMULADO TOTAL': 5, 'TAREA /ACCION': 'Unidades instaladas', 'ENERO': 1, 'FEBRERO': 1, 'MARZO': 1 },
            { 'AREA/DEPENDENCIA': 'Dir. de Inspecciones', 'INDICADOR': 'Actas de Comprobación Labradas', 'ACUMULADO TOTAL': 250, 'TAREA /ACCION': 'Actas de fiscalización', 'ENERO': 50, 'FEBRERO': 50, 'MARZO': 50 },
        ];

        const mockBarrios = [
            { 'NOMBRE DEL BARRIO': 'Norte Grande', 'DEPENDENCIA A CARGO': 'Dir. Gral. de Educación Ambiental', 'LATITUD': -24.7570, 'LONGITUD': -65.4190, 'TAREAS DESARROLLADAS': 'Operativo Puerta a Puerta' },
            { 'NOMBRE DEL BARRIO': 'San Francisco Solano', 'DEPENDENCIA A CARGO': 'Dir. Gral. de Educación Ambiental', 'LATITUD': -24.7700, 'LONGITUD': -65.4300, 'TAREAS DESARROLLADAS': 'Taller de compostaje' },
            { 'NOMBRE DEL BARRIO': 'Centro', 'DEPENDENCIA A CARGO': 'Dir. Gral. de Desarrollo Sostenible', 'LATITUD': -24.7891, 'LONGITUD': -65.4103, 'TAREAS DESARROLLADAS': 'Ecopunto Instalado' },
            { 'NOMBRE DEL BARRIO': 'Grandes Lagos', 'DEPENDENCIA A CARGO': 'Dir. General de Cambio Climático', 'LATITUD': -24.795, 'LONGITUD': -65.419, 'TAREAS DESARROLLADAS': 'Descacharrado y retiro de chatarra' },
        ];
        
        // ---------------------------------------------------------------------
        // FUNCIONES DE UTILIDAD (NO MODIFICAR)
        // ---------------------------------------------------------------------
        
        async function fetchGoogleSheetData(sheetName) {
            if (CONFIG.GOOGLE_SHEET_ID === 'REEMPLAZA_CON_TU_GOOGLE_SHEET_ID') {
                console.warn(`ID de Google Sheet no configurado. Usando mock data para ${sheetName}.`);
                return null;
            }
            const baseUrl = `https://docs.google.com/spreadsheets/d/${CONFIG.GOOGLE_SHEET_ID}/gviz/tq?tqx=out:json`;
            const query = `sheet=${sheetName}`;
            const url = `${baseUrl}&${query}`;
            
            try {
                const response = await fetch(url);
                const text = await response.text();
                const jsonText = text.replace('/*O_o*/\ngoogle.visualization.Query.setResponse(', '').replace(');', '');
                
                const data = JSON.parse(jsonText);
                
                if (data.status === 'error') {
                    console.error(`Error en API de Google Sheet (${sheetName}): ${data.errors.map(e => e.detailed_message).join(', ')}. Usando mock data.`);
                    return null;
                }

                return parseGoogleSheetResponse(data.table);
            } catch (error) {
                console.error(`Error al intentar cargar datos de ${sheetName}:`, error);
                return null;
            }
        }
        
        function parseGoogleSheetResponse(table) {
            const headers = table.cols.map(col => col.label || col.id);
            const rows = table.rows.map(row => {
                const obj = {};
                const cells = Array.from({ length: headers.length }, (_, i) => row.c[i] || { v: null, f: null });

                cells.forEach((cell, i) => {
                    const header = headers[i];
                    if (!header) return; 

                    let value = null;
                    if (cell) {
                        value = (cell.f !== null && cell.f !== undefined) ? cell.f : cell.v;
                    }
                    
                    if (typeof value === 'string') {
                        let cleanedValue = value.replace(/\./g, '').replace(',', '.').trim();
                        if (!isNaN(parseFloat(cleanedValue)) && cleanedValue !== '') {
                            obj[header] = parseFloat(cleanedValue);
                        } else {
                            obj[header] = value;
                        }
                    } else {
                        obj[header] = value;
                    }
                });
                return obj;
            }).filter(obj => 
                // Filtra filas que tienen al menos un indicador clave (para ignorar filas de título o vacías)
                obj[CONFIG.COL_AREA] !== null && obj[CONFIG.COL_AREA] !== undefined && obj[CONFIG.COL_INDICADOR] !== null && obj[CONFIG.COL_INDICADOR] !== undefined
            );
            return rows;
        }

        function getIconForIndicator(indicator) {
            const ind = indicator.toLowerCase();
            if (ind.includes('taller') || ind.includes('capacitac')) return 'fas fa-chalkboard-teacher';
            if (ind.includes('siembra') || ind.includes('arboles') || ind.includes('verde')) return 'fas fa-leaf';
            if (ind.includes('reciclado') || ind.includes('neumaton') || ind.includes('raee')) return 'fas fa-recycle';
            if (ind.includes('actas') || ind.includes('fiscalizacion') || ind.includes('inspecciones')) return 'fas fa-clipboard-list';
            if (ind.includes('resoluciones') || ind.includes('caam')) return 'fas fa-file-signature';
            if (ind.includes('biobarda') || ind.includes('descacharrado')) return 'fas fa-water';
            return 'fas fa-chart-line';
        }

        function createCard(title, value, task, icon, colorClass = 'bg-light') {
            const formattedValue = typeof value === 'number' ? value.toLocaleString('es-AR') : (value || 'N/A');
            return `
                <div class="col-lg-3 col-md-6 col-sm-12">
                    <div class="card indicator-card h-100 border-0 ${colorClass}">
                        <div class="card-body">
                            <div class="d-flex align-items-center">
                                <i class="${icon} fa-2x text-info me-3"></i>
                                <div>
                                    <p class="card-title text-uppercase mb-0">${title}</p>
                                    <h3 class="card-number mb-0">${formattedValue}</h3>
                                </div>
                            </div>
                            <small class="text-muted">${task || ''}</small>
                        </div>
                    </div>
                </div>
            `;
        }

        function createBarChart(canvasId, title, labels, datasetLabel, dataPoints, color) {
            const ctx = document.getElementById(canvasId);
            const noDataEl = document.getElementById(canvasId + '-no-data');
            const titleEl = document.getElementById(canvasId + '-title');

            if (currentChart) {
                currentChart.destroy();
            }

            if (!ctx || dataPoints.every(p => p === 0)) {
                if (noDataEl) noDataEl.classList.remove('d-none');
                ctx.style.display = 'none';
                titleEl.textContent = title;
                return;
            }

            if (noDataEl) noDataEl.classList.add('d-none');
            ctx.style.display = 'block';
            titleEl.textContent = `Avance Mensual: ${datasetLabel}`;

            currentChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: datasetLabel,
                        data: dataPoints,
                        backgroundColor: color,
                        borderColor: color,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function renderMap(areaName, filteredBarrios) {
            const mapEl = document.getElementById(mapContainerId);
            const noDataEl = document.getElementById(mapContainerId + '-no-data');
            const titleEl = document.getElementById(mapContainerId + '-title');
            
            if (currentMap) {
                currentMap.remove();
            }

            const validBarrios = filteredBarrios.filter(b => 
                b[CONFIG.COL_LAT] && b[CONFIG.COL_LON] && b[CONFIG.COL_LAT] !== 0 && b[CONFIG.COL_LON] !== 0
            );

            if (validBarrios.length === 0) {
                mapEl.style.display = 'none';
                noDataEl.classList.remove('d-none');
                titleEl.textContent = 'Sin Puntos/Barrios Intervenidos Mapeados';
                return;
            }

            mapEl.style.display = 'block';
            noDataEl.classList.add('d-none');
            titleEl.textContent = `Puntos/Barrios Intervenidos por ${areaName}`;
            
            const defaultCenter = [-24.782, -65.411]; 
            currentMap = L.map(mapContainerId).setView(defaultCenter, 12);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(currentMap);

            let markerLayer = L.featureGroup().addTo(currentMap);

            validBarrios.forEach(barrio => {
                const lat = parseFloat(barrio[CONFIG.COL_LAT]);
                const lon = parseFloat(barrio[CONFIG.COL_LON]);
                const name = barrio[CONFIG.COL_BARRIO_NOMBRE] || 'Punto Desconocido';
                const task = barrio[CONFIG.COL_BARRIO_TAREA] || 'Sin tarea especificada';
                
                L.marker([lat, lon])
                    .bindPopup(`<b>${name}</b><br>${task}<br><small>(${areaName})</small>`)
                    .addTo(markerLayer);
            });

            if (markerLayer.getBounds().isValid()) {
                currentMap.fitBounds(markerLayer.getBounds());
            } else {
                currentMap.setView(defaultCenter, 12);
            }
        }

        // ---------------------------------------------------------------------
        // LÓGICA DE RENDERIZADO DE PESTAÑAS
        // ---------------------------------------------------------------------

        function renderSection(areaName) {
            areaTitle.textContent = areaName;
            
            // 1. Inyectar Descripción
            descriptionContainer.innerHTML = `<div class="section-description"><p>${AREA_DESCRIPTIONS[areaName] || 'Descripción no disponible.'}</p></div>`;

            // 2. Filtrar Datos
            const filteredIndicators = indicatorsData.filter(item => item[CONFIG.COL_AREA] === areaName);
            const filteredBarrios = barriosData.filter(item => item['DEPENDENCIA A CARGO'] === areaName);

            // 3. Renderizar Cards
            indicatorsRow.innerHTML = '';
            if (filteredIndicators.length === 0) {
                indicatorsRow.innerHTML = '<div class="col-12"><p class="text-center text-muted">No hay indicadores numéricos cargados para esta área.</p></div>';
            } else {
                filteredIndicators.slice(0, 4).forEach(item => {
                    indicatorsRow.insertAdjacentHTML('beforeend', createCard(
                        item[CONFIG.COL_INDICADOR],
                        item[CONFIG.COL_ACUMULADO_TOTAL],
                        item[CONFIG.COL_TAREA],
                        getIconForIndicator(item[CONFIG.COL_INDICADOR]),
                        'bg-light'
                    ));
                });
            }

            // 4. Renderizar Gráfico
            if (filteredIndicators.length > 0) {
                const mainIndicator = filteredIndicators[0];
                const dataPoints = MONTH_COLUMNS.map(month => mainIndicator[month] || 0);
                createBarChart(
                    'chart-talleres',
                    'Avance Mensual',
                    MONTH_COLUMNS,
                    mainIndicator[CONFIG.COL_INDICADOR],
                    dataPoints,
                    'rgba(0, 77, 64, 0.7)' // Color verde oscuro
                );
            } else {
                // Forzar la destrucción del gráfico y mostrar mensaje de sin datos
                createBarChart('chart-talleres', 'Avance Mensual', [], '', [], '');
            }

            // 5. Renderizar Mapa
            renderMap(areaName, filteredBarrios);
        }

        // ---------------------------------------------------------------------
        // INICIALIZACIÓN DE LA APLICACIÓN
        // ---------------------------------------------------------------------
        async function initializeApp() {
            try {
                // 1. Cargar datos
                const fetchedIndicators = await fetchGoogleSheetData(CONFIG.SHEET_INDICADORES);
                indicatorsData = fetchedIndicators || mockIndicadores;

                const fetchedBarrios = await fetchGoogleSheetData(CONFIG.SHEET_BARRIOS);
                barriosData = fetchedBarrios || mockBarrios;

                // 2. Agregar Listeners a las pestañas del menú lateral
                const menuLinks = document.querySelectorAll('#area-menu a');
                
                menuLinks.forEach(link => {
                    // Al hacer clic en el link, disparamos la función de renderizado
                    link.addEventListener('click', (event) => {
                        event.preventDefault(); // Prevenir el salto de página si fuera necesario
                        const area = event.currentTarget.getAttribute('data-area');
                        renderSection(area);
                    });
                });
                
                // 3. Renderizar la sección por defecto (la pestaña activa inicial)
                const defaultArea = document.querySelector('#area-menu a.active').getAttribute('data-area');
                renderSection(defaultArea);

            } catch (error) {
                console.error("Fallo crítico en la inicialización. Usando mock data.", error);
                indicatorsData = mockIndicadores;
                barriosData = mockBarrios;
                const defaultArea = document.querySelector('#area-menu a.active').getAttribute('data-area');
                renderSection(defaultArea);

            } finally {
                loader.style.display = 'none';
            }
        }

        window.onload = initializeApp;

    </script>
</body>
</html>
